<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Code Share - [[${document.uniqueId}]]</title>
    <link rel="stylesheet" th:href="@{/style.css}">
    <link rel="stylesheet" th:href="@{/css/editor.css}">
</head>
<body>
    <div class="header">
        <h1>ðŸš€ Code Share</h1>
        <div class="controls">
            <select id="language-selector" class="language-selector">
                <option value="javascript">JavaScript</option>
                <option value="java">Java</option>
                <option value="html">HTML</option>
                <option value="markdown">Markdown</option>
                <option value="css">CSS</option>
                <option value="python">Python</option>
                <option value="json">JSON</option>
                <option value="plaintext">Plain Text</option>
            </select>
            <button id="copy-btn" class="copy-btn">ðŸ“‹ Copy Code</button>
        </div>
    </div>

    <div class="editor-wrapper">
        <div class="editor-header">
            <div class="document-info">
                <strong>Document:</strong> <span th:text="${document.uniqueId}"></span>
            </div>
            <div class="connection-indicator">
                <span class="connection-status">connecting</span>
                <div class="status-dot"></div>
            </div>
        </div>
        <div id="editor-container">
            <div id="cursor-overlay"></div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs/loader.js"></script>
    <script type="module" th:inline="javascript">
        /*<![CDATA[*/
        const ywsUrl = /*[[${ywsUrl}]]*/ 'ws://localhost:1234';
        const docId = /*[[${document.uniqueId}]]*/ 'default-room';
        const currentUsername = /*[[${currentUser.username}]]*/ 'Anonymous';
        /*]]>*/

        import * as Y from 'https://esm.sh/yjs@14.0.0-6';
        import { WebsocketProvider } from 'https://esm.sh/@y/websocket@4.0.0-1?alias=yjs:https://esm.sh/yjs@14.0.0-6';

        let monacoEditor;
        let ytext;
        let provider;
        let awareness;
        let isUpdatingFromY = false;

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            // Configure Monaco
            monaco.editor.defineTheme('code-share-theme', {
                base: 'vs',
                inherit: true,
                rules: [],
                colors: {
                    'editor.background': '#ffffff',
                    'editor.foreground': '#333333',
                    'editorLineNumber.foreground': '#999999',
                    'editor.selectionBackground': '#add6ff',
                    'editor.inactiveSelectionBackground': '#e5ebf1'
                }
            });

            monacoEditor = monaco.editor.create(document.getElementById('editor-container'), {
                value: '// Welcome to Code Share!\n// Start typing your code here...\n\n',
                language: 'javascript',
                theme: 'code-share-theme',
                fontSize: 14,
                fontFamily: "'Fira Code', 'Cascadia Code', 'JetBrains Mono', 'Source Code Pro', monospace",
                lineNumbers: 'on',
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                automaticLayout: true,
                wordWrap: 'on',
                folding: true,
                renderLineHighlight: 'all',
                selectOnLineNumbers: true,
                roundedSelection: false,
                readOnly: false,
                cursorStyle: 'line',
                cursorBlinking: 'blink',
                tabSize: 4,
                insertSpaces: true
            });

            initializeCollaboration();
        });

        function initializeCollaboration() {
            const ydoc = new Y.Doc();
            provider = new WebsocketProvider(ywsUrl, docId, ydoc);
            ytext = ydoc.getText('monaco');
            awareness = provider.awareness;
            const localClientId = awareness.clientID || ydoc.clientID;

            // Set user awareness
            const localUser = { 
                name: currentUsername, 
                color: colorFromId(localClientId),
                language: 'javascript'
            };
            awareness.setLocalState({ user: localUser, cursor: null });

            // Y.js to Monaco synchronization
            ytext.observe(event => {
                if (isUpdatingFromY) return;
                
                const content = ytext.toString();
                if (monacoEditor.getValue() !== content) {
                    isUpdatingFromY = true;
                    const position = monacoEditor.getPosition();
                    monacoEditor.setValue(content);
                    monacoEditor.setPosition(position);
                    isUpdatingFromY = false;
                }
            });

            // Monaco to Y.js synchronization
            monacoEditor.onDidChangeModelContent((event) => {
                if (isUpdatingFromY) return;
                
                ydoc.transact(() => {
                    const changes = event.changes.sort((a, b) => b.rangeOffset - a.rangeOffset);
                    
                    for (const change of changes) {
                        if (change.rangeLength > 0) {
                            ytext.delete(change.rangeOffset, change.rangeLength);
                        }
                        if (change.text.length > 0) {
                            ytext.insert(change.rangeOffset, change.text);
                        }
                    }
                }, 'monaco');
            });

            // Handle connection status
            const connectionStatusEl = document.querySelector('.connection-status');
            const connectionIndicator = document.querySelector('.connection-indicator');
            provider.on('status', event => {
                connectionStatusEl.textContent = event.status;
                connectionIndicator.className = 'connection-indicator ' + event.status;
            });

            // Set initial content on sync
            provider.on('sync', isSynced => {
                if (isSynced) {
                    const content = ytext.toString();
                    if (content.trim()) {
                        isUpdatingFromY = true;
                        monacoEditor.setValue(content);
                        isUpdatingFromY = false;
                    }
                }
            });

            setupCursorTracking();
        }

        function colorFromId(id) {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#FFA07A', '#98FB98'];
            return colors[id % colors.length];
        }

        function setupCursorTracking() {
            const container = document.getElementById('editor-container');
            const overlay = document.getElementById('cursor-overlay');

            // Track mouse movement for cursor awareness
            container.addEventListener('mousemove', (e) => {
                const rect = container.getBoundingClientRect();
                const x = (e.clientX - rect.left) / rect.width;
                const y = (e.clientY - rect.top) / rect.height;
                awareness.setLocalStateField('cursor', { x, y, t: Date.now() });
            });

            container.addEventListener('mouseleave', () => {
                awareness.setLocalStateField('cursor', null);
            });

            // Render other users' cursors
            function renderCursors() {
                const rect = container.getBoundingClientRect();
                overlay.innerHTML = '';
                const states = Array.from(awareness.getStates().entries());
                
                for (const [clientId, state] of states) {
                    if (!state || clientId === awareness.clientID) continue;
                    const cursor = state.cursor;
                    if (!cursor || typeof cursor.x !== 'number' || typeof cursor.y !== 'number') continue;
                    
                    const user = state.user || { name: `User ${clientId}`, color: colorFromId(clientId) };
                    const x = cursor.x * rect.width;
                    const y = cursor.y * rect.height;

                    const cursorEl = document.createElement('div');
                    cursorEl.style.position = 'absolute';
                    cursorEl.style.left = `${x}px`;
                    cursorEl.style.top = `${y}px`;
                    cursorEl.style.transform = 'translate(-50%, -50%)';
                    cursorEl.style.pointerEvents = 'none';
                    cursorEl.style.zIndex = '1001';

                    const dot = document.createElement('div');
                    dot.style.width = '12px';
                    dot.style.height = '12px';
                    dot.style.borderRadius = '50%';
                    dot.style.background = user.color;
                    dot.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                    cursorEl.appendChild(dot);

                    const label = document.createElement('div');
                    label.textContent = user.name;
                    label.style.position = 'absolute';
                    label.style.left = '15px';
                    label.style.top = '-8px';
                    label.style.fontSize = '11px';
                    label.style.padding = '2px 8px';
                    label.style.borderRadius = '12px';
                    label.style.color = '#fff';
                    label.style.background = user.color;
                    label.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
                    label.style.fontWeight = '500';
                    label.style.whiteSpace = 'nowrap';
                    cursorEl.appendChild(label);

                    overlay.appendChild(cursorEl);
                }
            }

            awareness.on('update', renderCursors);
            window.addEventListener('resize', renderCursors);
        }

        // Language selector
        document.getElementById('language-selector').addEventListener('change', (e) => {
            const language = e.target.value;
            monaco.editor.setModelLanguage(monacoEditor.getModel(), language);
            
            // Update user awareness with current language
            if (awareness) {
                const currentState = awareness.getLocalState();
                const user = currentState.user || {};
                user.language = language;
                awareness.setLocalStateField('user', user);
            }
        });

        // Copy functionality
        document.getElementById('copy-btn').addEventListener('click', async () => {
            try {
                const code = monacoEditor.getValue();
                await navigator.clipboard.writeText(code);
                showToast('Code copied to clipboard! ðŸ“‹');
            } catch (err) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = monacoEditor.getValue();
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Code copied to clipboard! ðŸ“‹');
            }
        });

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        showToast('Auto-saved! âœ“');
                        break;
                    case 'c':
                        if (e.shiftKey) {
                            e.preventDefault();
                            document.getElementById('copy-btn').click();
                        }
                        break;
                }
            }
        });

    </script>
</body>
</html>
